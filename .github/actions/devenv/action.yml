name: devenv
description: 'Setup development environment with devenv'

runs:
  using: composite
  steps:
    - name: cache nix store
      uses: actions/cache@3
      id: nix-cache
      with: 
        path: /tmp/nixcache
        key: ${{ runner.os }}-nix-cache

    - name: install nix
      uses: cachix/install-nix-action@v18

    - name: import nix store cache
      if: "steps.nix-cache.outputs.cache-hit == 'true'"
      run: "nix-store --import < /tmp/nixcache"

    - name: enable cachix
      uses: cachix/cachix-action@v12
      with: 
        name: devenv

    - name: install devenv.sh
      run: nix profile install github:cachix/devenv/v0.5
      shell: sh

    - name: run devenv in ci
      run: devenv ci

    - name: export nix store cache
      if: "steps.nix-cache.outputs.cache-hit != 'true'"
      run: "nix-store --export $(find /nix/store -maxdepth 1 -name '*-*')> /tmp/nixcache"
    